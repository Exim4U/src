SpamAssassin Installation Instructions - Tested With Version 3.2.5

These instructions cover Exim4U's recommended SpamAssassin implementation which includes
the following default and add-on components:

* SA Rules Channel - The default SpamAssassin rules.
* Open Protect Rules Channel - Additional rules from SARE (SpamAssassin Rules Emporium).
* Razor - Collaborative spam detection add-on using statistical signatures.
* DCC - Collaborative spam detection add-on using distributed checksums.
* Pyzor - Collaborative spam detection add-on using statistical signatures.

The SA Rules Channel and the Open Protect Rules Channel rely on the sa-update command
to check for updates to their spam detection rules as described in Steps 1 and 2
below. These rules change but they do not change frequently.  Therefore, crontab
should be utilized to have sa-update run periodically to fetch any updates to
these spam detection rules. sa-update should be run no more often than once per
day and once per week is generally sufficient.

Razor, DCC and Pyzor are very similar in methodology, however, it is beneficial to use
all three add-ons since each of the three spam data bases are unique.  In other
words, a given spam email may exist in one of the databases but not the other two.
Also, if a given spam exists in two or more data bases then the resulting spamscore
will be higher thus leading to better spam detection.

1) Install the default SA Rules Channel and all necessary perl modules that are not
   installed as per the "sa-update -D" command's report. SpamAssassin's RuleUpdates and
   sa-update are described here:

	http://wiki.apache.org/spamassassin/RuleUpdates

   The sa-update command updates SpamAssassin's rules after which SpamAssassin must
   be restarted to reflect changes.

   Run "sa-update" once to download the default SA rules from the channel
   "updates.spamassassin.org". This should enable SA find all its rules files
   under the "/var/lib/spamassassin" directory from now onwards. Import the default SA
   channel's GPG key and then run sa-update to import the key:

	wget http://spamassassin.apache.org/updates/GPG.KEY
	sa-update --import GPG.KEY

   Restart the spamassassin service:

	/etc/init.d/spamassassin restart

   (On some Linux distributions, the spamassassin service is named "spamd".)

   Now, run sa-update in debug mode:

	sa-update -D

   Running "sa-update -D" will probably generate errors like the following within its output:

	[28216] dbg: diag: module not installed: Mail::SPF:Query ('require' failed)

   Now, install the missing Perl modules. Most of these Perl modules are available in your
   Linux distribution's repositories or alternatively may be downloaded from:

	http://cpan.org

   The absence of the Razor module may generate a similar error as follows:

	[28216] dbg: diag: module not installed: Razor2::Client::Agent ('require' failed)

   Razor will be installed during step 3 below.

   Continue installing Perl modules until sa-update runs without any "module not installed"
   errors. SpamAssassin must be restarted after each sa-update execution for the changes 
   to take effect:

        /etc/init.d/spamassassin restart

2) Install Open Protect Rules Channel

   Follow the instructions verbatim at:

	http://saupdates.openprotect.com/

   After installing Open Protect's channel then run sa-update in debug mode as follows
   and review the    output:

	/usr/bin/sa-update --allowplugins -D --gpgkey D1C035168C1EBC08464946DA258CDB3ABDE9DC10 \
        --channel saupdates.openprotect.com --channel updates.spamassassin.org

   Continue installing any perl modules that are not installed as per the report. SpamAssassin
   must be restarted after each sa-update execution for the changes to take effect:

	/etc/init.d/spamassassin restart

   Continue installing Perl modules until sa-update runs without any "module not installed"
   errors

3) Razor Plugin For SpamAssassin

   Follow these installation instructions for a source code install:

	http://razor.sourceforge.net/docs/install.php

   Also, for RedHat/CentOS 5 systems, razor can be alternative installed
   from the RPMForge repostory with yum or apt.

   Follow these instructions to implement razor site wide with one configuration file
   and one log file:

	http://wiki.apache.org/spamassassin/RazorSiteWide

   SpamAssassin must be restarted for the changes to take effect:

        /etc/init.d/spamassassin restart

4) DCC Plugin For SpamAssassin

   The DCC plugin for spamassassin is found here:

	http://www.rhyolite.com/anti-spam/dcc/

   Additional documentation on DCC may be found here:

	http://wiki.apache.org/spamassassin/NetTestFirewallIssues
	http://www.linux.com/feature/114342

   Follow these instructions to compile and install DCC:

	wget http://www.rhyolite.com/anti-spam/dcc/source/dcc.tar.Z
	tar -zxvf dcc.tar.Z
	# Change the version number to the latest one
	cd dcc-1.3.82
	./configure
	make
	make install

	Edit DCC configuration file as follows:

		cd /var/dcc
		vi dcc_conf

	Change DCC to run as daemon:

		DCCD_ENABLE=off
		DCCIFD_ENABLE=on

	Turn off loging with:

		DCCM_LOG_AT=NEVER

	Set log retention to one day (just in case):

		DBCLEAN_LOGDAYS=1

	Uncomment the DCC plugin line in /etc/mail/spamassassin/v310.pre:

		loadplugin Mail::SpamAssassin::Plugin::DCC

	Copy the service startup script to init.d and add as a service
	according to your Linux distribution. As an example, for
	RedHat/CentOS:

		cd /etc/rc.d/init.d
		ln -s /var/dcc/libexec/rcDCC DCC
		chkconfig --add DCC
		service DCC start

	Install a cron job to clean up temp file on daily basis

		cd /etc/cron.daily
		ln -s /var/dcc/libexec/cron-dccd

	Configure SpamAssassin by editing local.cf to add the following lines:

		use_dcc 1
		dcc_home /var/dcc
		dcc_path /usr/local/bin/dccproc
		add_header all  DCC _DCCB_: _DCCR_


	Configure your firewall to allow UDP packets for port 6277. Assuming you
	allow all outbound packets out of your machine, you only need to add
	an INPUT rule to your /etc/sysconfig/iptables file. Add the following
	line in your INPUT chain, above any REJECT rules:

		-A <chain-name> -p udp -m udp --sport 6277 -j ACCEPT

	Restart iptables.

	To check the firewall, run 'cdcc info' after installing DCC:

		cdcc info

	The output should contain lines like this:

		dcc1.dcc-servers.net,- RTT+0 ms anon
		dcc2.dcc-servers.net,- RTT+0 ms anon ...

	There should be *at least one*, preferably more than half a dozen, 
	of the public DCC servers listed. If this is not the case, a likely
	cause is an interfering firewall.

   SpamAssassin must be restarted for the changes to take effect:

        /etc/init.d/spamassassin restart 

5) Pyzor SpamAssassin Installation

   The Pyzor home page is:

	http://sourceforge.net/apps/trac/pyzor/

   Download the latest version of Pyzor here:

	http://sourceforge.net/project/downloading.php?group_id=50000&filename=pyzor-0.5.0.tar.gz&a=83782234

   Extract the tarball:

	tar -xvzpf pyzor-0.5.0.tar.gz

   Then, follow the installation instructions in the INSTALL file in the root directory of the Pyzor download.

   Additional information on Pyzor may be found here:

	http://wiki.apache.org/spamassassin/UsingPyzor

   For RedHat/CentOS users, the ATRPMS repository at http://atrpms.net/dist/el5/pyzor/ has an rpm which is included
   in this distribution within the xtrasw directory:

	xtrasw/pyzor/pyzor-0.4.0-9.0.el5.noarch.rpm

   The install may mess up some of the permissions. We can fix it by issuing these commands:

	chmod -R a+rX /usr/share/doc/pyzor
	chmod -R a+rX /usr/lib/python2.4/site-packages/pyzor
	chmod -R a+rX /usr/bin/pyzor
	chmod -R a+rX /usr/bin/pyzord

   The gdbm module is required for Pyzor’s operation as well. You can check if it’s installed by running:

	python -c 'import gdbm' && echo 'gdbm found'

   If you get a “gdbm found”, you’re all set. If not:

	* For RedHat/CentOS run: yum install gdbm
	* For Debian, Gentoo and FreeBSD, instructions for obtaining the gdbm module are found in Pyzor's INSTALL
	  file in the root directory of the Pyzor download.

   Tell Pyzor to find the Pyzor server(s):

	pyzor discover

   Add the following to your /etc/mail/spamassassin/local.cf:

	pyzor_options --homedir /etc/mail/spamassassin

   Execute the following command:

	pyzor --homedir /etc/mail/spamassassin discover

   And finally, restart spamd:

	/etc/init.d/spamassassin restart

6) Exim4U checks the URIBL and SURBL lists within exim's ACLs. Therefore, you may disable the URIBL and SURBL
   RBL checks in spamassassin by setting all the score values to zero in my local.cf:

	# Disable URIBL and SURBL in SpamAssassin since I am now checking them in exim. 
	score   URIBL_BLACK     0.0 
	score   URIBL_GREY      0.0 
	score   URIBL_RED       0.0 
	score   URIBL_SC_SURBL  0.0 
	score   URIBL_WS_SURBL  0.0 
	score   URIBL_PH_SURBL  0.0 
	score   URIBL_OB_SURBL  0.0 
	score   URIBL_AB_SURBL  0.0 
	score   URIBL_JP_SURBL  0.0

7) To test spamassassin:

	spamassassin -D --lint 2>&1 | less

	To test spamassassin with a test email use the GTUBE test which can be downloaded from here:

		http://spamassassin.apache.org/gtube/gtube.txt

	Simply copy the contents to a file on the server and then execute spamassassin <test.eml>.
	This will exercise everything except the URIBL link checks which can be tested with any email
	that you create with a spam link.

8) Whitelisting In SpamAssassin

   See: http://spamassassin.apache.org/full/3.2.x/doc/Mail_SpamAssassin_Conf.html#whitelist_and_blacklist_options

   Use the command, “whitelist_from_rcvd”, to whitelist addresses but only if they come from the specified
   sending SMTP server's domain.  Example:

	# White Lists
	# localpart@domain.tld
	whitelist_from_rcvd localpart@domain.tld mail.domain.tld
	# Other examples
 	whitelist_from_rcvd joe@example.com  example.com
 	whitelist_from_rcvd *@axkit.org      sergeant.org

9) SpamAssassin PAM User Account Settings

   global settings file: /etc/mail/spamassassin/*.cf

   Individual account settings file: /home/<accountname>/.spamassassin/user_prefs
