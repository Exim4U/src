var frames={horde_main:true},DimpCore={view_id:1,remove_gc:[],server_error:0,buttons:["button_reply","button_forward","button_spam","button_ham","button_deleted"],debug:function(a,b){if(!this.is_logout&&DIMP.conf.debug){alert(a+": "+(b instanceof Error?b.name+"-"+b.message:Object.inspect(b)))}},toUIDArray:function(a){return a.get("dataob").collect(function(b){return this.toUIDString(b.imapuid,b.view)},this)},toUIDString:function(b,a){return b+DIMP.conf.idx_sep+a},doAction:function(c,d,b,e,a){if(!this.doActionOpts){this.doActionOpts={onException:function(f,g){this.debug("onException",g)}.bind(this),onFailure:function(f,g){this.debug("onFailure",f)}.bind(this)}}a=Object.extend(this.doActionOpts,a||{});d=$H(d);c=c.startsWith("*")?c.substring(1):DIMP.conf.URI_IMP+"/"+c;if(b&&b.size()){d.set("uid",b.toJSON())}if(DIMP.conf.SESSION_ID){d.update(DIMP.conf.SESSION_ID.toQueryParams())}a.parameters=d.toQueryString();a.onComplete=function(f,g){this.doActionComplete(f,e)}.bind(this);new Ajax.Request(c,a)},doActionComplete:function(c,f){this.inAjaxCallback=true;var a=false,b={};if(!c.responseText||!c.responseText.length){a=true}else{try{b=c.responseText.evalJSON(true)}catch(d){this.debug("doActionComplete",d);a=true}}if(!b.msgs){b.msgs=[]}if(a){if(++this.server_error==3){this.showNotifications([{type:"horde.error",message:DIMP.text.ajax_timeout}])}this.inAjaxCallback=false;return}if(b.response&&Object.isFunction(f)){try{f(b)}catch(d){this.debug("doActionComplete callback",d)}}if(this.server_error>=3){b.msgs.push({type:"horde.success",message:DIMP.text.ajax_recover})}this.server_error=0;if(!b.msgs_noauto){this.showNotifications(b.msgs)}if(this.onDoActionComplete){this.onDoActionComplete(b)}this.inAjaxCallback=false},setTitle:function(a){document.title=DIMP.conf.name+" :: "+a},showNotifications:function(a){if(!a.size()||this.is_logout){return}var b=$("alerts");if(!b){b=new Element("DIV",{id:"alerts"});$(document.body).insert(b)}a.find(function(c){switch(c.type){case"dimp.timeout":this.is_logout=true;this.redirect(DIMP.conf.timeout_url);return true;case"horde.error":case"horde.message":case"horde.success":case"horde.warning":case"imp.reply":case"imp.forward":case"imp.redirect":case"dimp.request":case"dimp.sticky":var g,e,f,d,h=new Element("DIV",{className:c.type.replace(".","-")});if($w("dimp.request dimp.sticky").indexOf(c.type)!=-1){h.update(c.message)}else{h.insert(c.message.unescapeHTML().unescapeHTML())}b.insert(h);if(DIMP.conf.is_ie6){f=new Element("DIV",{className:"ie6alertsfix"}).clonePosition(h,{setLeft:false,setTop:false});g=f;f.insert(h.remove());b.insert(f)}else{g=h}e=Effect.Fade.bind(this,h,{duration:1.5,afterFinish:this.removeAlert.bind(this)});g.observe("click",e);if($w("horde.error dimp.request dimp.sticky").indexOf(c.type)==-1){e.delay(c.type=="horde.warning"?10:5)}if(c.type=="dimp.request"){d=function(){e();document.stopObserving("click",d)};document.observe("click",d)}}},this)},removeAlert:function(c){try{var a=$(c.element),b=a.up();if(b&&b.parentNode){this.addGC(a.remove());if(!b.childElements().size()&&b.hasClassName("ie6alertsfix")){this.addGC(b.remove())}}}catch(d){this.debug("removeAlert",d)}},compose:function(c,b){var a=DIMP.conf.compose_url;b=b||{};if(c){b.type=c}this.popupWindow(this.addURLParam(a,b),"compose"+new Date().getTime())},popupWindow:function(b,a){if(!(window.open(b,a.replace(/\W/g,"_"),"width="+DIMP.conf.popup_width+",height="+DIMP.conf.popup_height+",status=1,scrollbars=yes,resizable=yes"))){this.showNotifications([{type:"horde.warning",message:DIMP.text.popup_block}])}},closePopup:function(){if(this.inAjaxCallback){this.closePopup.bind(this).defer()}else{window.close()}},logout:function(){this.is_logout=true;this.redirect(DIMP.conf.URI_IMP+"/LogOut")},redirect:function(a){a=this.addSID(a);if(parent.frames.horde_main){parent.location=a}else{window.location=a}},addMouseEvents:function(a){this.DMenu.addElement(a.id,"ctx_"+a.type,a)},removeMouseEvents:function(a){this.DMenu.removeElement($(a).readAttribute("id"));this.addGC(a)},addPopdown:function(b,a){var d=$(b),c=d.up();c.insert($($("popdown_img").cloneNode(false)).writeAttribute("id",b+"_img").show());this.addMouseEvents({id:b+"_img",type:a,offset:c,left:true})},buildAddressLinks:function(b){var a=0;$(b).select(".address").each(function(c){c.writeAttribute({id:"addr"+a++});c.observe("mouseover",function(){this.addMouseEvents({id:c.id,type:"contacts",offset:c,left:true})}.bind(this))},this);$("msgHeadersContent").select(".largeaddrlist").each(function(c){this.clickObserveHandler({d:c,f:function(){c.up().down().toggle().next().toggle().next().toggle()}})},this)},removeAddressLinks:function(a){[$(a).select(".address"),$(a).select(".largeaddrlist")].flatten().compact().each(this.removeMouseEvents.bind(this))},messageOnLoad:function(){var a=this.clickObserveHandler;if($("partlist")){a({d:$("partlist_col").up(),f:function(){$("partlist","partlist_col","partlist_exp").invoke("toggle")}})}if($("msg_print")){a({d:$("msg_print"),f:function(){window.print()}})}if($("msg_view_source")){a({d:$("msg_view_source"),f:function(){view(DIMP.conf.msg_source_link.unescapeHTML(),DIMP.conf.msg_index+"|"+DIMP.conf.msg_folder)}.bind(this)})}a({d:$("ctx_contacts_new"),f:function(){this.compose("new",{to:this.DMenu.element().readAttribute("address")})}.bind(this),ns:true});a({d:$("ctx_contacts_add"),f:function(){this.doAction("AddContact",{name:this.DMenu.element().readAttribute("personal"),email:this.DMenu.element().readAttribute("email")},null,true)}.bind(this),ns:true})},addGC:function(a){this.remove_gc=this.remove_gc.concat(a)},clickObserveHandler:function(a){return a.d.observe("click",DimpCore._clickFunc.curry(a))},_clickFunc:function(b,a){b.p?b.f(a):b.f();if(!b.ns){a.stop()}},addSID:function(a){if(!DIMP.conf.SESSION_ID){return a}return this.addURLParam(a,DIMP.conf.SESSION_ID.toQueryParams())},addURLParam:function(a,c){var b=a.indexOf("?");if(b!=-1){c=$H(a.toQueryParams()).merge(c).toObject();a=a.substring(0,b)}return a+"?"+Object.toQueryString(c)}};if(typeof ContextSensitive!="undefined"){DimpCore.DMenu=new ContextSensitive()}document.observe("dom:loaded",function(){try{if(parent.opener&&parent.opener.location.host==window.location.host&&parent.opener.DimpCore){DIMP.baseWindow=parent.opener.DIMP.baseWindow||parent.opener}}catch(a){}if(!DIMP.conf.spam_reporting){DimpCore.buttons=DimpCore.buttons.without("button_spam")}if(!DIMP.conf.ham_reporting){DimpCore.buttons=DimpCore.buttons.without("button_ham")}new PeriodicalExecuter(function(){if(DimpCore.remove_gc.size()){try{$A(DimpCore.remove_gc.splice(0,75)).compact().invoke("stopObserving")}catch(b){DimpCore.debug("remove_gc[].stopObserving",b)}}},10)});Element.addMethods({setText:function(b,c){var a=0;$A(b.childNodes).each(function(d){if(d.nodeType==3){if(a++){Element.remove(d)}else{d.nodeValue=c}}});if(!a){$(b).insert(c)}},getText:function(b,a){var c="";$A(b.childNodes).each(function(d){if(d.nodeType==3){c+=d.nodeValue}else{if(a&&d.hasChildNodes()){c+=$(d).getText(true)}}});return c}});Object.extend(String.prototype,{evalScripts:function(){var func,i=0,length,scripts=this.extractScripts(),re=/function\s+([^\s(]+)/g;for(length=scripts.size();i<length;++i){eval(scripts[i]);while(func=re.exec(scripts[i])){window[func[1]]=eval(func[1])}}}});function popup_imp(c,a,d,b){DimpCore.compose("new",b.toQueryParams().toObject())}function toggleQuoteBlock(e,b){var d=$("qb_"+e).toggle(),a=$("qt_"+e),c=a.down();c=a.down();if(c){c.remove()}a.insert(new Element("A",{className:"widget togglequote"}).setStyle({fontSize:"70%"}).insert("["+(d.visible()?DIMP.text.hidetext:DIMP.text.showtext+" - "+b+" "+DIMP.text.lines)+"]").observe("click",toggleQuoteBlock.curry(e,b)))}function view(a,b){window.open(a,++DimpCore.view_id+b.replace(/\W/g,"_"),"menubar=yes,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes")}if(Prototype.Browser.Opera&&opera.version()>=9.5){document.viewport.getDimensions=function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}}}Prototype.BrowserFeatures.SelectorsAPI=false;