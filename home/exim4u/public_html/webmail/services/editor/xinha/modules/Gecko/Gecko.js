Gecko._pluginInfo={name:"Gecko",origin:"Xinha Core",version:"$LastChangedRevision:998 $".replace(/^[^:]*:\s*(.*)\s*\$$/,"$1"),developer:"The Xinha Core Developer Team",developer_url:"$HeadURL:http://svn.xinha.webfactional.com/trunk/modules/Gecko/Gecko.js $".replace(/^[^:]*:\s*(.*)\s*\$$/,"$1"),sponsor:"",sponsor_url:"",license:"htmlArea"};function Gecko(A){this.editor=A;A.Gecko=this}Gecko.prototype.onKeyPress=function(S){var O=this.editor;var Q=O.getSelection();if(O.isShortCut(S)){switch(O.getKey(S).toLowerCase()){case"z":if(O._unLink&&O._unlinkOnUndo){Xinha._stopEvent(S);O._unLink();O.updateToolbar();return true}break;case"a":sel=O.getSelection();sel.removeAllRanges();range=O.createRange();range.selectNodeContents(O._doc.body);sel.addRange(range);Xinha._stopEvent(S);return true;break;case"v":if(!O.config.htmlareaPaste){return true}break}}switch(O.getKey(S)){case" ":var K=function(X,W){var V=X.nextSibling;if(typeof W=="string"){W=O._doc.createElement(W)}var U=X.parentNode.insertBefore(W,V);Xinha.removeFromParent(X);U.appendChild(X);V.data=" "+V.data;Q.collapse(V,1);O._unLink=function(){var Y=U.firstChild;U.removeChild(Y);U.parentNode.insertBefore(Y,U);Xinha.removeFromParent(U);O._unLink=null;O._unlinkOnUndo=false};O._unlinkOnUndo=true;return U};if(O.config.convertUrlsToLinks&&Q&&Q.isCollapsed&&Q.anchorNode.nodeType==3&&Q.anchorNode.data.length>3&&Q.anchorNode.data.indexOf(".")>=0){var P=Q.anchorNode.data.substring(0,Q.anchorOffset).search(/\S{4,}$/);if(P==-1){break}if(O._getFirstAncestor(Q,"a")){break}var N=Q.anchorNode.data.substring(0,Q.anchorOffset).replace(/^.*?(\S*)$/,"$1");var L=N.match(Xinha.RE_email);if(L){var I=Q.anchorNode;var G=I.splitText(Q.anchorOffset);var M=I.splitText(P);K(M,"a").href="mailto:"+L[0];break}RE_date=/([0-9]+\.)+/;RE_ip=/(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/;var J=N.match(Xinha.RE_url);if(J){if(RE_date.test(N)){break}var H=Q.anchorNode;var E=H.splitText(Q.anchorOffset);var D=H.splitText(P);K(D,"a").href=(J[1]?J[1]:"http://")+J[2];break}}break}switch(S.keyCode){case 27:if(O._unLink){O._unLink();Xinha._stopEvent(S)}break;break;case 8:case 46:if(!S.shiftKey&&this.handleBackspace()){Xinha._stopEvent(S)}default:O._unlinkOnUndo=false;if(Q.anchorNode&&Q.anchorNode.nodeType==3){var T=O._getFirstAncestor(Q,"a");if(!T){break}if(!T._updateAnchTimeout){if(Q.anchorNode.data.match(Xinha.RE_email)&&T.href.match("mailto:"+Q.anchorNode.data.trim())){var C=Q.anchorNode;var B=function(){T.href="mailto:"+C.data.trim();T._updateAnchTimeout=setTimeout(B,250)};T._updateAnchTimeout=setTimeout(B,1000);break}var R=Q.anchorNode.data.match(Xinha.RE_url);if(R&&T.href.match(new RegExp("http(s)?://"+Xinha.escapeStringForRegExp(Q.anchorNode.data.trim())))){var A=Q.anchorNode;var F=function(){R=A.data.match(Xinha.RE_url);if(R){T.href=(R[1]?R[1]:"http://")+R[2]}T._updateAnchTimeout=setTimeout(F,250)};T._updateAnchTimeout=setTimeout(F,1000)}}}break}return false};Gecko.prototype.handleBackspace=function(){var A=this.editor;setTimeout(function(){var F=A.getSelection();var H=A.createRange(F);var G=H.startContainer;var J=H.startOffset;var D=H.endContainer;var I=H.endOffset;var C=G.nextSibling;if(G.nodeType==3){G=G.parentNode}if(!(/\S/.test(G.tagName))){var E=document.createElement("p");while(G.firstChild){E.appendChild(G.firstChild)}G.parentNode.insertBefore(E,G);Xinha.removeFromParent(G);var B=H.cloneRange();B.setStartBefore(C);B.setEndAfter(C);B.extractContents();F.removeAllRanges();F.addRange(B)}},10)};Gecko.prototype.inwardHtml=function(A){A=A.replace(/<(\/?)strong(\s|>|\/)/ig,"<$1b$2");A=A.replace(/<(\/?)em(\s|>|\/)/ig,"<$1i$2");A=A.replace(/<(\/?)del(\s|>|\/)/ig,"<$1strike$2");return A};Gecko.prototype.outwardHtml=function(A){A=A.replace(/<script[\s]*src[\s]*=[\s]*['"]chrome:\/\/.*?["']>[\s]*<\/script>/ig,"");return A};Gecko.prototype.onExecCommand=function(J,D,H){try{this.editor._doc.execCommand("useCSS",false,true);this.editor._doc.execCommand("styleWithCSS",false,false)}catch(G){}switch(J){case"paste":alert(Xinha._lc("The Paste button does not work in Mozilla based web browsers (technical security reasons). Press CTRL-V on your keyboard to paste directly."));return true;break;case"removeformat":var A=this.editor;var C=A.getSelection();var L=A.saveSelection(C);var K=A.createRange(C);var E=A._doc.body.getElementsByTagName("*");var I=(K.startContainer.nodeType==1)?K.startContainer:K.startContainer.parentNode;var F,B;if(C.isCollapsed){K.selectNodeContents(A._doc.body)}for(F=0;F<E.length;F++){B=E[F];if(K.isPointInRange(B,0)||(E[F]==I&&K.startOffset==0)){B.removeAttribute("style")}}this.editor._doc.execCommand(J,D,H);A.restoreSelection(L);return true;break}return false};Gecko.prototype.onMouseDown=function(B){if(B.target.tagName.toLowerCase()=="hr"){var C=this.editor.getSelection();var A=this.editor.createRange(C);A.selectNode(B.target)}};Xinha.prototype.insertNodeAtSelection=function(G){if(G.ownerDocument!=this._doc){try{G=this._doc.adoptNode(G)}catch(E){}}var C=this.getSelection();var D=this.createRange(C);C.removeAllRanges();D.deleteContents();var B=D.startContainer;var F=D.startOffset;var A=G;switch(B.nodeType){case 3:if(G.nodeType==3){B.insertData(F,G.data);D=this.createRange();D.setEnd(B,F+G.length);D.setStart(B,F+G.length);C.addRange(D)}else{B=B.splitText(F);if(G.nodeType==11){A=A.firstChild}B.parentNode.insertBefore(G,B);this.selectNodeContents(A);this.updateToolbar()}break;case 1:if(G.nodeType==11){A=A.firstChild}B.insertBefore(G,B.childNodes[F]);this.selectNodeContents(A);this.updateToolbar();break}};Xinha.prototype.getParentElement=function(B){if(typeof B=="undefined"){B=this.getSelection()}var D=this.createRange(B);try{var C=D.commonAncestorContainer;if(!D.collapsed&&D.startContainer==D.endContainer&&D.startOffset-D.endOffset<=1&&D.startContainer.hasChildNodes()){C=D.startContainer.childNodes[D.startOffset]}while(C.nodeType==3){C=C.parentNode}return C}catch(A){return null}};Xinha.prototype.activeElement=function(A){if((A===null)||this.selectionEmpty(A)){return null}if(!A.isCollapsed){if(A.anchorNode.childNodes.length>A.anchorOffset&&A.anchorNode.childNodes[A.anchorOffset].nodeType==1){return A.anchorNode.childNodes[A.anchorOffset]}else{if(A.anchorNode.nodeType==1){return A.anchorNode}else{return null}}}return null};Xinha.prototype.selectionEmpty=function(A){if(!A){return true}if(typeof A.isCollapsed!="undefined"){return A.isCollapsed}return true};Xinha.prototype.saveSelection=function(){return this.createRange(this.getSelection()).cloneRange()};Xinha.prototype.restoreSelection=function(A){var B=this.getSelection();B.removeAllRanges();B.addRange(A)};Xinha.prototype.selectNodeContents=function(C,E){this.focusEditor();this.forceRedraw();var B;var A=typeof E=="undefined"?true:false;var D=this.getSelection();B=this._doc.createRange();if(!C){D.removeAllRanges();return}if(A&&C.tagName&&C.tagName.toLowerCase().match(/table|img|input|textarea|select/)){B.selectNode(C)}else{B.selectNodeContents(C)}D.removeAllRanges();D.addRange(B)};Xinha.prototype.insertHTML=function(F){var B=this.getSelection();var C=this.createRange(B);this.focusEditor();var A=this._doc.createDocumentFragment();var E=this._doc.createElement("div");E.innerHTML=F;while(E.firstChild){A.appendChild(E.firstChild)}var D=this.insertNodeAtSelection(A)};Xinha.prototype.getSelectedHTML=function(){var A=this.getSelection();if(A.isCollapsed){return""}var B=this.createRange(A);return Xinha.getHTML(B.cloneContents(),false,this)};Xinha.prototype.getSelection=function(){return this._iframe.contentWindow.getSelection()};Xinha.prototype.createRange=function(B){this.activateEditor();if(typeof B!="undefined"){try{return B.getRangeAt(0)}catch(A){return this._doc.createRange()}}else{return this._doc.createRange()}};Xinha.prototype.isKeyEvent=function(A){return A.type=="keypress"};Xinha.prototype.getKey=function(A){return String.fromCharCode(A.charCode)};Xinha.getOuterHTML=function(A){return(new XMLSerializer()).serializeToString(A)};Xinha.prototype.cc=String.fromCharCode(8286);Xinha.prototype.setCC=function(A){var C=this.cc;try{if(A=="textarea"){var D=this._textArea;var I=D.selectionStart;var H=D.value.substring(0,I);var G=D.value.substring(I,D.value.length);if(G.match(/^[^<]*>/)){var F=G.indexOf(">")+1;D.value=H+G.substring(0,F)+C+G.substring(F,G.length)}else{D.value=H+C+G}D.value=D.value.replace(new RegExp("(&[^"+C+"]*?)("+C+")([^"+C+"]*?;)"),"$1$3$2");D.value=D.value.replace(new RegExp("(<script[^>]*>[^"+C+"]*?)("+C+")([^"+C+"]*?<\/script>)"),"$1$3$2");D.value=D.value.replace(new RegExp("^([^"+C+"]*)("+C+")([^"+C+"]*<body[^>]*>)(.*?)"),"$1$3$2$4")}else{var B=this.getSelection();B.getRangeAt(0).insertNode(this._doc.createTextNode(C))}}catch(E){}};Xinha.prototype.findCC=function(J){if(J=="textarea"){var B=this._textArea;var E=B.value.indexOf(this.cc);if(E==-1){return}var A=E+this.cc.length;var H=B.value.substring(0,E);var G=B.value.substring(A,B.value.length);B.value=H;B.scrollTop=B.scrollHeight;var F=B.scrollTop;B.value+=G;B.setSelectionRange(E,E);B.focus();B.scrollTop=F}else{try{var I=this._doc;I.body.innerHTML=I.body.innerHTML.replace(new RegExp(this.cc),'<span id="XinhaEditingPostion"></span>');var D=I.getElementById("XinhaEditingPostion");this.selectNodeContents(D);D.scrollIntoView(true);D.parentNode.removeChild(D);this._iframe.contentWindow.focus()}catch(C){}}};Xinha.prototype._standardToggleBorders=Xinha.prototype._toggleBorders;Xinha.prototype._toggleBorders=function(){var C=this._standardToggleBorders();var B=this._doc.getElementsByTagName("TABLE");for(var A=0;A<B.length;A++){B[A].style.display="none";B[A].style.display="table"}return C};Xinha.getDoctype=function(A){var B="";if(A.doctype){B+="<!DOCTYPE "+A.doctype.name+" PUBLIC ";B+=A.doctype.publicId?'"'+A.doctype.publicId+'"':"";B+=A.doctype.systemId?' "'+A.doctype.systemId+'"':"";B+=">"}return B};