WebKit._pluginInfo={name:"WebKit",origin:"Xinha Core",version:"$LastChangedRevision:998 $".replace(/^[^:]*:\s*(.*)\s*\$$/,"$1"),developer:"The Xinha Core Developer Team",developer_url:"$HeadURL:http://svn.xinha.webfactional.com/trunk/modules/WebKit/WebKit.js $".replace(/^[^:]*:\s*(.*)\s*\$$/,"$1"),sponsor:"",sponsor_url:"",license:"htmlArea"};function WebKit(A){this.editor=A;A.WebKit=this}WebKit.prototype.onKeyPress=function(S){var O=this.editor;var Q=O.getSelection();if(O.isShortCut(S)){switch(O.getKey(S).toLowerCase()){case"z":if(O._unLink&&O._unlinkOnUndo){Xinha._stopEvent(S);O._unLink();O.updateToolbar();return true}break;case"a":break;case"v":if(!O.config.htmlareaPaste){return true}break}}switch(O.getKey(S)){case" ":var K=function(X,W){var V=X.nextSibling;if(typeof W=="string"){W=O._doc.createElement(W)}var U=X.parentNode.insertBefore(W,V);Xinha.removeFromParent(X);U.appendChild(X);V.data=" "+V.data;Q.collapse(V,1);O._unLink=function(){var Y=U.firstChild;U.removeChild(Y);U.parentNode.insertBefore(Y,U);Xinha.removeFromParent(U);O._unLink=null;O._unlinkOnUndo=false};O._unlinkOnUndo=true;return U};if(O.config.convertUrlsToLinks&&Q&&Q.isCollapsed&&Q.anchorNode.nodeType==3&&Q.anchorNode.data.length>3&&Q.anchorNode.data.indexOf(".")>=0){var P=Q.anchorNode.data.substring(0,Q.anchorOffset).search(/\S{4,}$/);if(P==-1){break}if(O._getFirstAncestor(Q,"a")){break}var N=Q.anchorNode.data.substring(0,Q.anchorOffset).replace(/^.*?(\S*)$/,"$1");var L=N.match(Xinha.RE_email);if(L){var I=Q.anchorNode;var G=I.splitText(Q.anchorOffset);var M=I.splitText(P);K(M,"a").href="mailto:"+L[0];break}RE_date=/([0-9]+\.)+/;RE_ip=/(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/;var J=N.match(Xinha.RE_url);if(J){if(RE_date.test(N)){break}var H=Q.anchorNode;var E=H.splitText(Q.anchorOffset);var D=H.splitText(P);K(D,"a").href=(J[1]?J[1]:"http://")+J[2];break}}break}switch(S.keyCode){case 13:if(S.shiftKey){}break;case 27:if(O._unLink){O._unLink();Xinha._stopEvent(S)}break;case 8:case 46:if(!S.shiftKey&&this.handleBackspace()){Xinha._stopEvent(S)}break;default:O._unlinkOnUndo=false;if(Q.anchorNode&&Q.anchorNode.nodeType==3){var T=O._getFirstAncestor(Q,"a");if(!T){break}if(!T._updateAnchTimeout){if(Q.anchorNode.data.match(Xinha.RE_email)&&T.href.match("mailto:"+Q.anchorNode.data.trim())){var C=Q.anchorNode;var B=function(){T.href="mailto:"+C.data.trim();T._updateAnchTimeout=setTimeout(B,250)};T._updateAnchTimeout=setTimeout(B,1000);break}var R=Q.anchorNode.data.match(Xinha.RE_url);if(R&&T.href.match(new RegExp("http(s)?://"+Xinha.escapeStringForRegExp(Q.anchorNode.data.trim())))){var A=Q.anchorNode;var F=function(){R=A.data.match(Xinha.RE_url);if(R){T.href=(R[1]?R[1]:"http://")+R[2]}T._updateAnchTimeout=setTimeout(F,250)};T._updateAnchTimeout=setTimeout(F,1000)}}}break}return false};WebKit.prototype.handleBackspace=function(){var A=this.editor;setTimeout(function(){var F=A.getSelection();var H=A.createRange(F);var G=H.startContainer;var J=H.startOffset;var D=H.endContainer;var I=H.endOffset;var C=G.nextSibling;if(G.nodeType==3){G=G.parentNode}if(!(/\S/.test(G.tagName))){var E=document.createElement("p");while(G.firstChild){E.appendChild(G.firstChild)}G.parentNode.insertBefore(E,G);Xinha.removeFromParent(G);var B=H.cloneRange();B.setStartBefore(C);B.setEndAfter(C);B.extractContents();F.removeAllRanges();F.addRange(B)}},10)};WebKit.prototype.inwardHtml=function(A){return A};WebKit.prototype.outwardHtml=function(A){return A};WebKit.prototype.onExecCommand=function(N,F,K){this.editor._doc.execCommand("styleWithCSS",false,false);switch(N){case"paste":alert(Xinha._lc("The Paste button does not work in the Safari browser for security reasons. Press CTRL-V on your keyboard to paste directly."));return true;break;case"removeformat":var A=this.editor;var E=A.getSelection();var P=A.saveSelection(E);var O=A.createRange(E);var G=A._doc.getElementsByTagName("*");G=Xinha.collectionToArray(G);var M=(O.startContainer.nodeType==1)?O.startContainer:O.startContainer.parentNode;var H,D,L,I,C,B=A._doc.createRange();function J(R){if(R.nodeType!=1){return}R.removeAttribute("style");for(var Q=0;Q<R.childNodes.length;Q++){J(R.childNodes[Q])}if((R.tagName.toLowerCase()=="span"&&!R.attributes.length)||R.tagName.toLowerCase()=="font"){B.selectNodeContents(R);I=B.extractContents();while(I.firstChild){C=I.removeChild(I.firstChild);R.parentNode.insertBefore(C,R)}R.parentNode.removeChild(R)}}if(E.isCollapsed){G=A._doc.body.childNodes;for(H=0;H<G.length;H++){D=G[H];if(D.nodeType!=1){continue}if(D.tagName.toLowerCase()=="span"){L=A.convertNode(D,"div");D.parentNode.replaceChild(L,D);D=L}J(D)}}else{for(H=0;H<G.length;H++){D=G[H];if(O.isPointInRange(D,0)||(G[H]==M&&O.startOffset==0)){J(D)}}}B.detach();A.restoreSelection(P);return true;break}return false};WebKit.prototype.onMouseDown=function(A){if(A.target.tagName.toLowerCase()=="hr"||A.target.tagName.toLowerCase()=="img"){this.editor.selectNodeContents(A.target)}};Xinha.prototype.insertNodeAtSelection=function(F){var C=this.getSelection();var D=this.createRange(C);C.removeAllRanges();D.deleteContents();var B=D.startContainer;var E=D.startOffset;var A=F;switch(B.nodeType){case 3:if(F.nodeType==3){B.insertData(E,F.data);D=this.createRange();D.setEnd(B,E+F.length);D.setStart(B,E+F.length);C.addRange(D)}else{B=B.splitText(E);if(F.nodeType==11){A=A.firstChild}B.parentNode.insertBefore(F,B);this.selectNodeContents(A);this.updateToolbar()}break;case 1:if(F.nodeType==11){A=A.firstChild}B.insertBefore(F,B.childNodes[E]);this.selectNodeContents(A);this.updateToolbar();break}};Xinha.prototype.getParentElement=function(B){if(typeof B=="undefined"){B=this.getSelection()}var D=this.createRange(B);try{var C=D.commonAncestorContainer;if(!D.collapsed&&D.startContainer==D.endContainer&&D.startOffset-D.endOffset<=1&&D.startContainer.hasChildNodes()){C=D.startContainer.childNodes[D.startOffset]}while(C.nodeType==3){C=C.parentNode}return C}catch(A){return null}};Xinha.prototype.activeElement=function(A){if((A===null)||this.selectionEmpty(A)){return null}if(!A.isCollapsed){if(A.anchorNode.childNodes.length>A.anchorOffset&&A.anchorNode.childNodes[A.anchorOffset].nodeType==1){return A.anchorNode.childNodes[A.anchorOffset]}else{if(A.anchorNode.nodeType==1){return A.anchorNode}else{return null}}}return null};Xinha.prototype.selectionEmpty=function(A){if(!A){return true}if(typeof A.isCollapsed!="undefined"){return A.isCollapsed}return true};Xinha.prototype.saveSelection=function(){return this.createRange(this.getSelection()).cloneRange()};Xinha.prototype.restoreSelection=function(A){var B=this.getSelection();B.removeAllRanges();B.addRange(A)};Xinha.prototype.selectNodeContents=function(C,E){this.focusEditor();this.forceRedraw();var B;var A=typeof E=="undefined"?true:false;var D=this.getSelection();B=this._doc.createRange();if(A&&C.tagName&&C.tagName.toLowerCase().match(/table|img|input|textarea|select/)){B.selectNode(C)}else{B.selectNodeContents(C)}D.removeAllRanges();D.addRange(B)};Xinha.prototype.insertHTML=function(F){var B=this.getSelection();var C=this.createRange(B);this.focusEditor();var A=this._doc.createDocumentFragment();var E=this._doc.createElement("div");E.innerHTML=F;while(E.firstChild){A.appendChild(E.firstChild)}var D=this.insertNodeAtSelection(A)};Xinha.prototype.getSelectedHTML=function(){var A=this.getSelection();if(A.isCollapsed){return""}var B=this.createRange(A);if(B){return Xinha.getHTML(B.cloneContents(),false,this)}else{return""}};Xinha.prototype.getSelection=function(){return this._iframe.contentWindow.getSelection()};Xinha.prototype.createRange=function(B){this.activateEditor();if(typeof B!="undefined"){try{return B.getRangeAt(0)}catch(A){return this._doc.createRange()}}else{return this._doc.createRange()}};Xinha.prototype.isKeyEvent=function(A){return A.type=="keypress"};Xinha.prototype.getKey=function(B){var A=String.fromCharCode(parseInt(B.keyIdentifier.replace(/^U\+/,""),16));if(B.shiftKey){return A}else{return A.toLowerCase()}};Xinha.getOuterHTML=function(A){return(new XMLSerializer()).serializeToString(A)};Xinha.prototype.cc=String.fromCharCode(8286);Xinha.prototype.setCC=function(I){var B=this.cc;try{if(I=="textarea"){var C=this._textArea;var H=C.selectionStart;var G=C.value.substring(0,H);var F=C.value.substring(H,C.value.length);if(F.match(/^[^<]*>/)){var E=F.indexOf(">")+1;C.value=G+F.substring(0,E)+B+F.substring(E,F.length)}else{C.value=G+B+F}C.value=C.value.replace(new RegExp("(&[^"+B+"]*?)("+B+")([^"+B+"]*?;)"),"$1$3$2");C.value=C.value.replace(new RegExp("(<script[^>]*>[^"+B+"]*?)("+B+")([^"+B+"]*?<\/script>)"),"$1$3$2");C.value=C.value.replace(new RegExp("^([^"+B+"]*)("+B+")([^"+B+"]*<body[^>]*>)(.*?)"),"$1$3$2$4")}else{var A=this.getSelection();A.getRangeAt(0).insertNode(this._doc.createTextNode(B))}}catch(D){}};Xinha.prototype.findCC=function(K){if(K=="textarea"){var B=this._textArea;var F=B.value.indexOf(this.cc);if(F==-1){return}var A=F+this.cc.length;var I=B.value.substring(0,F);var H=B.value.substring(A,B.value.length);B.value=I;B.scrollTop=B.scrollHeight;var G=B.scrollTop;B.value+=H;B.setSelectionRange(F,F);B.focus();B.scrollTop=G}else{var E=this;try{var J=this._doc;J.body.innerHTML=J.body.innerHTML.replace(new RegExp(this.cc),'<span id="XinhaEditingPostion"></span>');var D=J.getElementById("XinhaEditingPostion");this.selectNodeContents(D);this.scrollToElement(D);D.parentNode.removeChild(D);this._iframe.contentWindow.focus()}catch(C){}}};Xinha.prototype._standardToggleBorders=Xinha.prototype._toggleBorders;Xinha.prototype._toggleBorders=function(){var C=this._standardToggleBorders();var A=this._doc.getElementsByTagName("TABLE");for(var B=0;B<A.length;B++){A[B].style.display="none";A[B].style.display="table"}return C};Xinha.getDoctype=function(A){var B="";if(A.doctype){B+="<!DOCTYPE "+A.doctype.name+" PUBLIC ";B+=A.doctype.publicId?'"'+A.doctype.publicId+'"':"";B+=A.doctype.systemId?' "'+A.doctype.systemId+'"':"";B+=">"}return B};