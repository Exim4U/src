EnterParagraphs._pluginInfo={name:"EnterParagraphs",version:"1.0",developer:"Adam Wright",developer_url:"http://www.hipikat.org/",sponsor:"The University of Western Australia",sponsor_url:"http://www.uwa.edu.au/",license:"htmlArea"};EnterParagraphs.prototype._whiteSpace=/^\s*$/;EnterParagraphs.prototype._pExclusions=/^(address|blockquote|body|dd|div|dl|dt|fieldset|form|h1|h2|h3|h4|h5|h6|hr|li|noscript|ol|p|pre|table|ul)$/i;EnterParagraphs.prototype._pContainers=/^(body|del|div|fieldset|form|ins|map|noscript|object|td|th)$/i;EnterParagraphs.prototype._pBreak=/^(address|pre|blockquote)$/i;EnterParagraphs.prototype._permEmpty=/^(area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$/i;EnterParagraphs.prototype._elemSolid=/^(applet|br|button|hr|img|input|table)$/i;EnterParagraphs.prototype._pifySibling=/^(address|blockquote|del|div|dl|fieldset|form|h1|h2|h3|h4|h5|h6|hr|ins|map|noscript|object|ol|p|pre|table|ul|)$/i;EnterParagraphs.prototype._pifyForced=/^(ul|ol|dl|table)$/i;EnterParagraphs.prototype._pifyParent=/^(dd|dt|li|td|th|tr)$/i;function EnterParagraphs(A){this.editor=A;if(Xinha.is_gecko){this.onKeyPress=this.__onKeyPress}}EnterParagraphs.prototype.name="EnterParagraphs";EnterParagraphs.prototype.insertAdjacentElement=function(C,B,A){if(B=="BeforeBegin"){C.parentNode.insertBefore(A,C)}else{if(B=="AfterEnd"){C.nextSibling?C.parentNode.insertBefore(A,C.nextSibling):C.parentNode.appendChild(A)}else{if(B=="AfterBegin"&&C.firstChild){C.insertBefore(A,C.firstChild)}else{if(B=="BeforeEnd"||B=="AfterBegin"){C.appendChild(A)}}}}};EnterParagraphs.prototype.forEachNodeUnder=function(F,E,D,C){var A,B;if(F.nodeType==11&&F.firstChild){A=F.firstChild;B=F.lastChild}else{A=B=F}while(B.lastChild){B=B.lastChild}return this.forEachNode(A,B,E,D,C)};EnterParagraphs.prototype.forEachNode=function(L,K,J,I,H){var G=function(N,M){return(M=="ltr"?N.nextSibling:N.previousSibling)};var F=function(N,M){return(M=="ltr"?N.firstChild:N.lastChild)};var D,B,E;var C=H;var A=false;while(D!=I=="ltr"?K:L){if(!D){D=I=="ltr"?L:K}else{if(F(D,I)){D=F(D,I)}else{if(G(D,I)){D=G(D,I)}else{B=D;while(!G(B,I)&&B!=(I=="ltr"?K:L)){B=B.parentNode}D=(G(B,I)?G(B,I):B)}}}A=(D==(I=="ltr"?K:L));switch(J){case"cullids":E=this._fenCullIds(D,C);break;case"find_fill":E=this._fenEmptySet(D,C,J,A);break;case"find_cursorpoint":E=this._fenEmptySet(D,C,J,A);break}if(E[0]){return E[1]}if(A){break}if(E[1]){C=E[1]}}return false};EnterParagraphs.prototype._fenEmptySet=function(B,A,D,C){if(!A&&!B.firstChild){A=B}if((B.nodeType==1&&this._elemSolid.test(B.nodeName))||(B.nodeType==3&&!this._whiteSpace.test(B.nodeValue))||(B.nodeType!=1&&B.nodeType!=3)){switch(D){case"find_fill":return new Array(true,false);break;case"find_cursorpoint":return new Array(true,B);break}}if(C){return new Array(true,A)}return new Array(false,A)};EnterParagraphs.prototype._fenCullIds=function(C,B,A){if(B.id){A[B.id]?B.id="":A[B.id]=true}return new Array(false,A)};EnterParagraphs.prototype.processSide=function(C,B){var A=function(I,H){return(H=="left"?I.previousSibling:I.nextSibling)};var F=B=="left"?C.startContainer:C.endContainer;var E=B=="left"?C.startOffset:C.endOffset;var D,G=F;while(G.nodeType==1&&!this._permEmpty.test(G.nodeName)){G=(E?G.lastChild:G.firstChild)}while(D=D?(A(D,B)?A(D,B):D.parentNode):G){if(A(D,B)){if(this._pExclusions.test(A(D,B).nodeName)){return this.processRng(C,B,D,A(D,B),(B=="left"?"AfterEnd":"BeforeBegin"),true,false)}}else{if(this._pContainers.test(D.parentNode.nodeName)){return this.processRng(C,B,D,D.parentNode,(B=="left"?"AfterBegin":"BeforeEnd"),true,false)}else{if(this._pExclusions.test(D.parentNode.nodeName)){if(this._pBreak.test(D.parentNode.nodeName)){return this.processRng(C,B,D,D.parentNode,(B=="left"?"AfterBegin":"BeforeEnd"),false,(B=="left"?true:false))}else{return this.processRng(C,B,(D=D.parentNode),(A(D,B)?A(D,B):D.parentNode),(A(D,B)?(B=="left"?"AfterEnd":"BeforeBegin"):(B=="left"?"AfterBegin":"BeforeEnd")),false,false)}}}}}};EnterParagraphs.prototype.processRng=function(B,K,H,A,P,O,M){var L=K=="left"?B.startContainer:B.endContainer;var J=K=="left"?B.startOffset:B.endOffset;var I=this.editor;var G=I._doc.createRange();G.selectNode(H);if(K=="left"){G.setEnd(L,J);B.setStart(G.startContainer,G.startOffset)}else{if(K=="right"){G.setStart(L,J);B.setEnd(G.endContainer,G.endOffset)}}var C=G.cloneContents();this.forEachNodeUnder(C,"cullids","ltr",this.takenIds,false,false);var F,D,N;F=K=="left"?(G.endContainer.nodeType==3?true:false):(G.startContainer.nodeType==3?false:true);D=F?G.startOffset:G.endOffset;F=F?G.startContainer:G.endContainer;if(this._pifyParent.test(F.nodeName)&&F.parentNode.childNodes.item(0)==F){while(!this._pifySibling.test(F.nodeName)){F=F.parentNode}}if(C.nodeType==11&&!C.firstChild){if(F.nodeName!="BODY"||(F.nodeName=="BODY"&&D!=0)){C.appendChild(I._doc.createElement(F.nodeName))}}N=this.forEachNodeUnder(C,"find_fill","ltr",false);if(N&&this._pifySibling.test(F.nodeName)&&((D==0)||(D==1&&this._pifyForced.test(F.nodeName)))){H=I._doc.createElement("p");H.innerHTML="&nbsp;";if((K=="left")&&F.previousSibling){return new Array(F.previousSibling,"AfterEnd",H)}else{if((K=="right")&&F.nextSibling){return new Array(F.nextSibling,"BeforeBegin",H)}else{return new Array(F.parentNode,(K=="left"?"AfterBegin":"BeforeEnd"),H)}}}if(N){if(N.nodeType==3){N=I._doc.createDocumentFragment()}if((N.nodeType==1&&!this._elemSolid.test())||N.nodeType==11){var E=I._doc.createElement("p");E.innerHTML="&nbsp;";N.appendChild(E)}else{var E=I._doc.createElement("p");E.innerHTML="&nbsp;";N.parentNode.insertBefore(parentNode,N)}}if(N){H=N}else{H=(O||(C.nodeType==11&&!C.firstChild))?I._doc.createElement("p"):I._doc.createDocumentFragment();H.appendChild(C)}if(M){H.appendChild(I._doc.createElement("br"))}return new Array(A,P,H)};EnterParagraphs.prototype.isNormalListItem=function(A){var C,B;C=A.startContainer;if((typeof C.nodeName!="undefined")&&(C.nodeName.toLowerCase()=="li")){B=C}else{if((typeof C.parentNode!="undefined")&&(typeof C.parentNode.nodeName!="undefined")&&(C.parentNode.nodeName.toLowerCase()=="li")){B=C.parentNode}else{return false}}if(!B.previousSibling){if(A.startOffset==0){return false}}return true};EnterParagraphs.prototype.__onKeyPress=function(A){if(A.keyCode==13&&!A.shiftKey&&this.editor._iframe.contentWindow.getSelection){return this.handleEnter(A)}};EnterParagraphs.prototype.handleEnter=function(I){var C;var B=this.editor.getSelection();var A=this.editor.createRange(B);if(this.isNormalListItem(A)){return true}this.takenIds=new Object();var H=this.processSide(A,"left");var F=this.processSide(A,"right");C=F[2];B.removeAllRanges();A.deleteContents();var E=this.forEachNodeUnder(C,"find_cursorpoint","ltr",false,true);if(!E){alert("INTERNAL ERROR - could not find place to put cursor after ENTER")}if(H){this.insertAdjacentElement(H[0],H[1],H[2])}if(F&&F.nodeType!=1){this.insertAdjacentElement(F[0],F[1],F[2])}if((E)&&(this._permEmpty.test(E.nodeName))){var D=0;while(E.parentNode.childNodes.item(D)!=E){D++}B.collapse(E.parentNode,D)}else{try{B.collapse(E,0);if(E.nodeType==3){E=E.parentNode}this.editor.scrollToElement(E)}catch(G){}}this.editor.updateToolbar();Xinha._stopEvent(I);return true};